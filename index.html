<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HT-chat</title>
  <link rel="stylesheet" href="css/htgov.css" />
  <style>
    .logo {
      position: absolute;
      left: 0;
      top: 0;
      height: 60px;
      width: 60px;
      object-fit: cover;
      cursor: pointer;
      z-index: 10;
    }

    /* èŠå¤©æ¡†æ ·å¼ */
    #chat-box {
      width: 95%;
      height: 60vh;
      border: 2px solid #333;
      overflow-y: auto;
      margin: 10px auto;
      padding: 15px;
      background: saddlebrown;  /* âœ… æ£•è‰²èƒŒæ™¯ */
      display: flex;
      flex-direction: column;
      font-size: 16px;
      border-radius: 10px;
    }

    .message {
      margin: 6px;
      padding: 10px 14px;
      border-radius: 10px;
      max-width: 65%;
      word-wrap: break-word;
      font-size: 15px;
    }
    .message.other {
      align-self: flex-start;
      background: orange;
      color: black;
    }
    .message.me {
      align-self: flex-end;
      background: deepskyblue;
      color: white;
      text-align: right;
    }
  </style>
</head>
<body>
  <!-- âœ… é¡¶éƒ¨ header -->
  <div class="header">
    <!-- å·¦è¾¹LOGO -->
    <a href="https://htcb-12c7.github.io/">
      <img class="logo" src="assets/HTgovIconV2.png" alt="è¿”å›ä¸»é¡µ">
    </a>
    HT-chat <span></span>

    <!-- Language æŒ‰é’® -->
    <button id="lang-toggle" style="
      position: absolute;
      top: 10px;
      right: 70px;
      padding: 8px 16px;
      font-size: 16px;
      background: black;
      color: #03a9f4;
      border: 1px solid #03a9f4;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;">
      ğŸŒ Language
    </button>

    <!-- ç™»å½•å¤´åƒåŒºåŸŸï¼ˆå³ä¸Šè§’ï¼‰ -->
    <div id="accountContainer" style="position:absolute; top:10px; right:10px;"></div>
  </div>

  <!-- âœ… åŠ è½½ç™»å½•/å¤´åƒç»„ä»¶ -->
  <script>
    fetch("components/account.html")
      .then(r => r.text())
      .then(html => {
        document.getElementById("accountContainer").innerHTML = html;
        import("/js/auth.js"); // ç™»å½•é€»è¾‘
      });
  </script>

  <!-- Google ç¿»è¯‘è¯­è¨€æ¡† -->
  <div id="google_translate_element" style="
    position: absolute;
    top: 50px;
    right: 0px;
    display: none;
    background: rgba(0, 0, 0, 0.8);
    padding: 8px;
    border-radius: 5px;
    z-index: 9999;
  "></div>

  <div class="main-container">
    <div class="sidebar">
      <h3>é»‘é“å·¥ä½œå®¤</h3>
      <ul id="sidebar-nav"></ul>
    </div>
    <div class="content">
      <div class="container">
        <h2>HT é€ä¸–èŠå¤©</h2>
        <div id="chat-box"></div>

        <div style="display: flex; width: 100%; gap: 5px;">
          <input type="text" id="msg" placeholder="è¾“å…¥æ¶ˆæ¯..." 
            style="flex: 8; padding: 10px; border: 1px solid #aaa; border-radius:5px;
            background: gold; color: black;" />

          <button onclick="sendMsg()" 
            style="flex: 2; border: none; border-radius: 5px;
            background: green; color: black; font-weight: bold; cursor: pointer;">
            å¯åŠ¨/å›è½¦
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… èŠå¤©é€»è¾‘ï¼ˆFirebaseï¼‰ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, get, remove } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCDKAAxNpKqcSsS2onwlKANl9tLmCy6UGo",
      authDomain: "ht-chat-91e5f.firebaseapp.com",
      databaseURL: "https://ht-chat-91e5f-default-rtdb.firebaseio.com",
      projectId: "ht-chat-91e5f",
      storageBucket: "ht-chat-91e5f.firebasestorage.app",
      messagingSenderId: "325331727527",
      appId: "1:325331727527:web:d994b7241a7cc28e9dd782",
      measurementId: "G-VYV13LWP14"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const messagesRef = ref(db, "messages");

    const chatBox = document.getElementById("chat-box");
    const msgInput = document.getElementById("msg");

    // âœ… è¾“å…¥æ˜µç§°
    let username = "";
    while (!username) {
      username = prompt("è¯·è¾“å…¥ä½ çš„æ˜µç§°ï¼š");
    }

    // âœ… æ¸…ç†æ—§æ¶ˆæ¯
    async function cleanupMessages() {
      const snapshot = await get(messagesRef);
      if (snapshot.exists()) {
        const allMessages = snapshot.val();
        const keys = Object.keys(allMessages);
        if (keys.length > 270) {
          const oldKeys = keys.slice(0, 200);
          oldKeys.forEach((key) => {
            remove(ref(db, "messages/" + key));
          });
        }
      }
    }

    // âœ… æ˜¾ç¤ºæ¶ˆæ¯
    onChildAdded(messagesRef, (snapshot) => {
      const msgData = snapshot.val();
      const time = new Date(msgData.time).toLocaleTimeString();
      const isMe = msgData.user === username;
      const msgClass = isMe ? "me" : "other";
      chatBox.innerHTML += `<div class="message ${msgClass}">
        <b>[${time}] ${msgData.user}:</b> ${msgData.text}
      </div>`;
      chatBox.scrollTop = chatBox.scrollHeight;
      cleanupMessages();
    });

    // âœ… å‘é€æ¶ˆæ¯
    window.sendMsg = function () {
      const text = msgInput.value.trim();
      if (text) {
        push(messagesRef, {
          user: username,
          text: text,
          time: Date.now()
        });
        msgInput.value = "";
      }
    };

    // âœ… å›è½¦å‘é€
    msgInput.addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        event.preventDefault();
        sendMsg();
      }
    });
  </script>

  <!-- Google ç¿»è¯‘ç»„ä»¶ -->
  <script>
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({
        pageLanguage: 'zh-CN',
        includedLanguages: 'zh-CN,en,ja,ko,fr,es,de,ru',
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE
      }, 'google_translate_element');
    }
  </script>
  <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

  <!-- Language æŒ‰é’®é€»è¾‘ -->
  <script>
    window.addEventListener('load', function () {
      const toggle = document.getElementById("lang-toggle");
      const box = document.getElementById("google_translate_element");
      if (toggle && box) {
        toggle.addEventListener("click", () => {
          box.style.display = box.style.display === "none" ? "block" : "none";
        });
      }
    });
  </script>
</body>
</html>
